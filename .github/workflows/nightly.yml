name: nightly
on:
  schedule:
    - cron: "15 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  nightly-suite:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: openwatt
          POSTGRES_USER: openwatt
          POSTGRES_PASSWORD: openwatt
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U openwatt -d openwatt"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      OPENWATT_DATABASE_URL: postgresql+asyncpg://openwatt:openwatt@localhost:5432/openwatt
      OPENWATT_ENABLE_DB: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Install Python deps
        run: pip install -r requirements.txt
      - name: Apply DDL
        run: python scripts/apply_ddl.py --database-url ${{ env.OPENWATT_DATABASE_URL }}
      - name: Seed reference data
        run: python -m api.app.db.seed
      - name: Run pytest (DB + parser snapshots)
        run: pytest
      - name: Smoke ingest snapshot regeneration
        run: >
          python -m ingest.pipeline edf
          --html tests/snapshots/edf/edf_2025_02.html
          --observed-at 2025-02-12T08:00:00Z
          --persist
          --output artifacts/ci_edf.json
      - name: Flag verifying payloads
        run: |
          python -c '
          import json
          from pathlib import Path

          payload = json.loads(Path("artifacts/ci_edf.json").read_text())
          statuses = {item.get("data_status") for item in payload}
          if "verifying" in statuses:
              print("::warning::Observation en cours de verification (data_status=verifying)")
          '
      - name: Upload ingest artifact
        uses: actions/upload-artifact@v4
        with:
          name: ingest-output
          path: artifacts/ci_edf.json
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        env:
          SUPPLIER: edf
        with:
          script: |
            const supplier = process.env.SUPPLIER || 'unknown';
            const today = new Date().toISOString().split('T')[0];
            const title = '[INGEST BROKEN] ' + supplier + ' - ' + today;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ingest'
            });

            const existing = issues.data.find(i => i.title.includes(supplier.toUpperCase()));
            if (existing) {
              console.log('Issue already exists for ' + supplier + ': #' + existing.number);
              return;
            }

            const runUrl = context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;

            let body = '## Ingest pipeline failed for ' + supplier + '\n\n';
            body += '**Error:** See workflow logs for details\n\n';
            body += '**Run:** ' + runUrl + '\n\n';
            body += '**Runbook:** Check `docs/parsers/' + supplier.toLowerCase() + '.md` for troubleshooting steps\n\n';
            body += '## Action needed\n\n';
            body += '1. Check the workflow logs for error messages\n';
            body += '2. Verify the source URL is still accessible\n';
            body += '3. Check if the PDF/HTML structure has changed\n';
            body += '4. Update the parser config if needed\n';
            body += '5. Close this issue once resolved';

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ingest'],
              assignees: ['rodjac-lab']  // Auto-assign to receive notifications
            });
            console.log('Created issue #' + issue.data.number + ' and assigned to rodjac-lab');
