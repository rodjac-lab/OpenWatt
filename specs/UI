---
id: openwatt.ui
version: 0.1.0
status: draft
last_updated: 2025-11-11
---

# UI Stack & Contrats (OpenWatt)

## Stack
- Framework: Next.js (App Router)
- Style: Tailwind CSS + shadcn/ui (Radix)
- Thème: next-themes (dark mode: class)
- Data: TanStack Query (+ Zod côté client)
- Table: TanStack Table (+ virtualisation si >200 lignes)
- Charts: Recharts
- Forms: React Hook Form + Zod

## Pages (MVP)
- `/` (Comparateur)
  - Filtres: `puissance_kva`, `option`, `conso_kwh`, `%hc (si HPHC)`
  - Résultats: tri par `annual_cost` (TTC), badges `fresh/suspect/stale`, `delta_vs_trve_pct`
- `/provider/[slug]` (Détail fournisseur)
  - Graphique historique (price/abo) + liste d’observations
- `/methodology`, `/api` (doc)

## Contrats front (API)
- GET `/v1/tariffs?option=&puissance=&include_stale=`
  - Réponse: liste `Tariff` (voir `specs/openapi.yaml#components/schemas/Tariff`)
  - Le front calcule `annual_cost`:
    - BASE: `conso_kwh * price_kwh_ttc + 12 * abo_month_ttc`
    - HPHC: `conso_hp * price_hp + conso_hc * price_hc + 12 * abo`
- GET `/v1/tariffs/history?...` pour `/provider/[slug]`

## États & badges
- `fresh` (≤7j), `suspect` (≤48h), `stale` (>14j, masqué par défaut), `broken` (exclu)
- Deltas: afficher `±x% vs TRVE`

## Acceptation UI (MVP)
- Filtres réactifs (aucun reload)
- Table triable par coût annuel
- Dark mode toggle persistant
- Chargement: skeletons, erreurs: toasts

## Admin console (observabilité interne)
- `/admin` réservé aux opérateurs (auth simple).
- **Jobs nightly** : liste des exécutions ingest (min: status OK/NOK, fournisseur, timestamp, message d'erreur si NOK). Affichage type timeline + badge cause ("fetch_failed", "parse_error", "persist_blocked").
- **Santé base** : indicateur agrégé du freshness (pourcentage d'observations `fresh` vs `stale/broken`) + alertes lorsque un fournisseur est >7j. Carte résumée + lien vers détail.
- **Inspection PDF** : interface pour déposer/choisir un PDF (`tests/snapshots/...`) et afficher les tables extraites (basée sur l'outil CLI backlog) pour valider colonnes/puissances. Possibilité de voir le diff YAML -> table.
- **Override source** : formulaire permettant de saisir temporairement une URL PDF/HTML et lancer `python -m ingest.pipeline <supplier> --fetch` avec cette URL (stockage en base + log). Journalisation + confirmation.
- **Gestion fournisseurs** : vue listant tous les parsers configurés (nom, version, URL source, statut activé/désactivé). Actions rapides : éditer l'URL source (ou champ YAML), désactiver/activer un fournisseur, bouton "Ajouter un fournisseur" qui pré-remplit un YAML à partir d'un template (avec checklist snapshots/tests). Indique si les snapshots de référence existent et si les tests `pytest -k <supplier>` passent (dernière exécution).
- **Monitoring API** : mini section montrant latence moyenne et taux d'erreur des endpoints `/v1/tariffs` et `/v1/tariffs/history` (données issues des logs uvicorn ou d'un ping interne). Si indispo, afficher un bandeau "API degraded".
